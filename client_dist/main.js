!function(t){function e(e){for(var r,i,a=e[0],l=e[1],c=e[2],h=0,p=[];h<a.length;h++)i=a[h],n[i]&&p.push(n[i][0]),n[i]=0;for(r in l)Object.prototype.hasOwnProperty.call(l,r)&&(t[r]=l[r]);for(d&&d(e);p.length;)p.shift()();return o.push.apply(o,c||[]),s()}function s(){for(var t,e=0;e<o.length;e++){for(var s=o[e],r=!0,a=1;a<s.length;a++){var l=s[a];0!==n[l]&&(r=!1)}r&&(o.splice(e--,1),t=i(i.s=s[0]))}return t}var r={},n={1:0};var o=[];function i(e){if(r[e])return r[e].exports;var s=r[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=r,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="";var a=window.webpackJsonp=window.webpackJsonp||[],l=a.push.bind(a);a.push=e,a=a.slice();for(var c=0;c<a.length;c++)e(a[c]);var d=l;o.push([26,0]),s()}({26:function(t,e,s){"use strict";s.r(e);var r=s(1);s(25);class n{constructor(t){this.element=t,this.eventListeners=[]}bind(t,e){for(const s of t.split(" ")){this.eventListeners.push({eventName:s,eventFunction:e});const t=t=>e(t.detail,t);this.element.addEventListener(s,t,!1)}}getListeners(){return this.eventListeners}trigger(t,e){this.element.dispatchEvent(new CustomEvent(t,{detail:e}))}}let o=0;class i{static simpleUId({prefix:t=""}){return t+(o+=1)}}class a{static translate({x:t,y:e}){return"translate("+t+","+e+")"}static group(t,e,s={x:0,y:0}){return t.append("g").attrs({class:e,transform:a.translate(s)})}}class l{constructor(t,e=""){this.measureElement=t.append("text").attrs({x:0,y:-20,class:e})}textLength(t,e=null){this.measureElement.attr("style",e),this.measureElement.text(t);const s=this.measureElement.node().getComputedTextLength();return this.measureElement.text(""),s}}class c{constructor(t,e){this.id=i.simpleUId({}),this.parent=t,this.eventHandler=e||new n(this.base.node()),this._current={hidden:!1}}superInit(t={},e=!0,s=!0,r=!0){Object.keys(t).forEach(e=>this.options[e]=t[e]),this.layers={},r&&(this.base=a.group(this.parent,this.css_name+" ID"+this.id,this.options.pos),e&&(this.layers.bg=a.group(this.base,"bg"),this.layers.main=a.group(this.base,"main"),this.layers.fg=a.group(this.base,"fg"))),s&&this._init()}update(t){this.data=t,this._current.hidden||(this.renderData=this._wrangle(t),this._render(this.renderData))}updateOptions({options:t,reRender:e=!1}){Object.keys(t).forEach(e=>this.options[e]=t[e]),e&&this._render(this.renderData)}setHideElement(t){this._current.hideElement=t}hideView(){if(!this._current.hidden){(this._current.hideElement||this.parent).transition().styles({opacity:0,"pointer-events":"none"}).style("display","none"),this._current.hidden=!0}}unhideView(){if(this._current.hidden){(this._current.hideElement||this.parent).transition().styles({opacity:1,"pointer-events":null,display:null}),this._current.hidden=!1}}destroy(){this.base.remove()}}var d;c.events={noEvent:"VComponent_noEvent"},function(t){t[t.fixed=0]="fixed",t[t.flow=1]="flow"}(d||(d={}));class h extends c{constructor(t,e,s={}){super(t,e),this.css_name="wordline",this.options={pos:{x:0,y:0},text_measurer:null,box_height:23,box_width:100,box_type:h.BoxType.flow,css_class_main:"inWord",css_class_add:"",x_offset:3},this.superInit(s)}_init(){this.options.text_measurer=this.options.text_measurer||new l(this.parent,"measureWord")}_wrangle(t){const e=this.options;let s=[];const n=[],o=(s=e.box_type===h.BoxType.fixed?t.wordRows.map(t=>t.map(t=>(t=>({text:t,width:e.box_width-10,realWidth:e.text_measurer.textLength(t)}))(t))):t.wordRows.map(t=>t.map(t=>(t=>({text:t,width:Math.max(e.text_measurer.textLength(t),20)}))(t)))).map(t=>(t=>{let e=0;const s=[...t.map(t=>{const s=e;return e+=+t.width+10,s})];return n.push(e),s})(t));return this.parent.attrs({width:r.j(n)+6,height:s.length*e.box_height-2}),this._current.selectedWord=null,this._current.clearSelections=!0,this._current.customFill=null!=t.wordFill,this._current.customBorder=null!=t.wordBorder,this._current.customBoxWidth=null!=t.boxWidth,{rows:s,positions:o,wordFill:t.wordFill,wordBorder:t.wordBorder,boxWidth:t.boxWidth}}hoverWord(t,e,s){const r={hovered:s,caller:this,word:t,row:t.row,col:t.col,css_class_main:this.options.css_class_main};this.eventHandler.trigger(h.events.wordHovered,r)}clickWord(t,e){const s=!(this._current.selectedWord===e);this._current.selectedWord=s?e:null;const r={hovered:s,caller:this,row:t.row,word:t,col:t.col,css_class_main:this.options.css_class_main};this.eventHandler.trigger(h.events.wordSelected,r)}actionHighlightWord(t,e,s,n=!1,o="highlight"){this.base.selectAll(`.${this.options.css_class_main}`).classed(o,function(i){return i.row===t&&i.col===e?s:!n&&r.m(this).classed(o)})}_render(t){const e=this.options;let s=this.base.selectAll(".word_row").data(t.rows);s.exit().remove();let r=(s=s.enter().append("g").attr("class","word_row").merge(s).attr("transform",(t,s)=>`translate(${e.x_offset},${s*e.box_height})`)).selectAll(`.${e.css_class_main}`).data((t,e)=>t.map((t,s)=>({row:e,word:t,col:s})));r.exit().remove();const n=r.enter().append("g").attr("class",`${e.css_class_main} ${e.css_class_add}`);n.append("rect").attrs({x:-3,y:0,height:e.box_height-2,rx:3,ry:3}),n.append("text");const o=n.merge(r).attrs({transform:(e,s)=>`translate(${t.positions[e.row][s]},0)`}).on("mouseenter",(t,e)=>this.hoverWord(t,e,!0)).on("mouseout",(t,e)=>this.hoverWord(t,e,!1)).on("click",(t,e)=>this.clickWord(t,e)),i=o.select("rect");this._current.customBoxWidth?i.attr("width",(e,s)=>t.boxWidth[e.row][s]+6):i.attr("width",t=>t.word.width+6),this._current.customFill&&i.style("fill",(e,s)=>t.wordFill[e.row][s]),this._current.customBorder&&i.style("stroke",(e,s)=>t.wordBorder[e.row][s]),o.select("text").attr("transform",t=>{const s=t.word;return e.box_type===h.BoxType.fixed&&s.width<s.realWidth&&s.realWidth>0?`translate(${.5*t.word.width},${Math.floor(e.box_height/2)})scale(${s.width/s.realWidth},1)`:`translate(${.5*t.word.width},${Math.floor(e.box_height/2)})`}).text(t=>t.word.text),this._current.clearSelections&&(this.actionHighlightWord(-1,-1,!1,!0,"selected"),this._current.clearSelections=!1)}get positions(){return this.renderData.positions}get rows(){return this.renderData.rows}get firstRowPlainWords(){return this.renderData.rows[0].map(t=>t.text)}}h.events={wordHovered:"wordline_word_hovered",wordSelected:"wordline_word_selected"},h.BoxType=d;var p,u=s(2);!function(t){t[t.src=0]="src",t[t.tgt=1]="tgt"}(p||(p={}));class m extends c{constructor(t,e,s={}){super(t,e),this.css_name="attentionvis",this.options={pos:{x:0,y:0},max_bundle_width:15,height:50,css_class_main:"attn_graph",css_edge:"attn_edge",x_offset:3},this.superInit(s,!1)}_init(){}_createGraph(t,e,s,n,o,i){const a=Object(u.unzip)(t),l=a.map(t=>Object(u.sum)(t)),c=Math.max(1,Object(u.max)(l)),d=r.k().domain([0,c]).range([0,e]);let h=0;const p=s.map((t,e)=>{let s=o[e]+.5*(t-d(l[e]));return n.map((t,r)=>{const n=d(a[e][r]),o=s+.5*n;return s+=d(a[e][r]),h=s>h?s:h,{inPos:o,width:n,edge:[e,r],classes:`in${e} out${r}`,outPos:null}})});return n.forEach((t,e)=>{let r=i[e]+.5*(t-d(1));s.forEach((t,s)=>{const n=p[s][e];n.outPos=r+.5*n.width,r+=n.width,h=r>h?r:h})}),{edges:Object(u.flatten)(p).filter(t=>t.width>0),maxPos:h}}_wrangle(t){const{edges:e,maxPos:s}=this._createGraph(t.edgeWeights,this.options.max_bundle_width,t.inWidths,t.outWidths,t.inPos,t.outPos);return this.parent.attrs({width:s+5+this.options.x_offset,height:this.options.height}),{edges:e,maxPos:s}}_render(t){const e=this.options,s=this.base.selectAll(`.${e.css_class_main}`).data(t.edges);s.exit().remove();const n=r.i(),o=s.enter().append("g").attr("class",e.css_class_main);o.append("path"),o.merge(s).select("path").attrs({d:t=>n({source:[t.inPos+e.x_offset,0],target:[t.outPos+e.x_offset,e.height]}),class:t=>`${this.options.css_edge} ${t.classes}`}).style("stroke-width",t=>t.width)}actionHighlightEdges(t,e,s,r="highlight"){s?this.base.selectAll(`.${this.options.css_class_main}`).classed(r,s=>s.edge[e]===t):this.base.selectAll(`.${this.options.css_class_main}`).classed(r,!1)}}m.VERTEX_TYPE=p,m.events={};var g=s(15);class _ extends c{constructor(t,e,s={}){super(t,e),this.css_name="wordprojector",this.options={pos:{x:0,y:0},height:400,width:500,css_class_main:"wp_vis",hidden:!1,data_access:{pos:t=>t.pos,scores:t=>t.score,words:t=>t.word,compare:t=>t.compare},text_measurer:null,loc:null},this.layout=[{name:"bg",pos:[0,0]},{name:"main",pos:[0,0]}],this.superInit(s)}_init(){const t=this.options;this.options.text_measurer=this.options.text_measurer||new l(this.parent,"measureWord"),this.parent.attrs({width:t.width,height:t.height}),this.options.hidden&&this.hideView()}_wrangle(t){const e=this.options,s=e.data_access.pos(t),r=s.map(t=>t[0]),n=s.map(t=>t[1]),o=Object(u.min)(r),i=Object(u.min)(n),a=Object(u.max)(r)-o,l=Object(u.max)(n)-i;let c=[];c=a>l?s.map(t=>[(t[0]-o)/a,(t[1]-i)/a]):s.map(t=>[(t[0]-o)/l,(t[1]-i)/l]);const d=e.data_access.words(t),h=e.data_access.scores(t),p=e.data_access.compare(t);return this._current.has_compare=null!==p,this._current.clearHighlights=!0,Object(u.sortBy)(Object(u.zipWith)(d,h,c,p,(t,e,s,r)=>({word:t,score:e,pos:s,compare:r})),t=>-t.score)}_render(t){const e=this.options,s=this.layers.main.selectAll(".word").data(t);s.exit().remove();const n=s.enter().append("g").attr("class","word");n.append("rect"),n.append("text");const o=r.k().range([30,e.width-30]),i=r.k().range([10,e.height-10]),a=r.d(t.map(t=>t.score)),l=r.k().domain(a).range([10,12]),c=this.removeOverlap(t,l,o,i,e.text_measurer),d=n.merge(s);d.attr("transform",t=>`translate(${c[t.word].cx}, ${c[t.word].cy})`),d.on("click",t=>this.clickWord(t)),d.classed("query",(t,e)=>0==e),d.select("rect").attrs({width:(t,e)=>c[t.word].w,height:(t,e)=>c[t.word].h-2,x:(t,e)=>.5*-c[t.word].w,y:(t,e)=>.5*-c[t.word].h+1}),d.select("text").text(t=>t.word).style("font-size",t=>l(t.score)+"pt"),this._current.clearHighlights&&(this.highlightWord(null,!1),this._current.clearHighlights=!1)}removeOverlap(t,e,s,r,n){const o=[];for(const i of t){const t=i.word,a=e(i.score),l=s(i.pos[0]),c=r(i.pos[1]),d=n.textLength(t,"font-size:"+a+"pt;");o.push(new g.Rectangle(l-d/2-4,l+d/2+4,c-a/2-3,c+a/2+3))}Object(g.removeOverlaps)(o);const i={};return o.forEach((e,s)=>{i[t[s].word]={cx:.5*(e.X+e.x),cy:.5*(e.Y+e.y),w:e.X-e.x,h:e.Y-e.y}}),i}highlightWord(t,e,s=!0,n="selected"){const o=this.layers.main.selectAll(".word");!e&&s?o.classed(n,!1):o.classed(n,function(o){return o.word===t?e:!s&&r.m(this).classed(n)})}clickWord(t){this.eventHandler.trigger(_.events.wordClicked,{caller:this,wordObj:t,sentence:t.compare.orig,word:t.word})}}_.events={wordClicked:"WordProjector_word_clicked"};class w{static ajax_request(t){const e=(t,e,s)=>new Promise((r,n)=>{const o=new XMLHttpRequest;let i=e;!s||"POST"!==t&&"GET"!==t&&"PUT"!==t||(i+="?",s.forEach((t,e)=>{t&&(i+="&",i+=encodeURIComponent(e)+"="+encodeURIComponent(t))})),o.open(t,i),o.send(),o.onload=function(){this.status>=200&&this.status<300?r(this.response):n(this.statusText)},o.onerror=function(){n(this.statusText)}});return{get:s=>e("GET",t,s),post:s=>e("POST",t,s),put:s=>e("PUT",t,s),delete:s=>e("DELETE",t,s)}}}class v{static project_info(t){const e=w.ajax_request("../api/project_info");let s=new Map;return t&&(s=new Map([["project_id",t]])),e.get(s)}static translate({input:t,partial:e=[],force_attn:s={},neighbors:r=["decoder","encoder"]}){const n=w.ajax_request("../api/translate");let o=null;for(const t in s)o||(o=[]),o.push(t),o.push(s[t]);const i=new Map([["in",t],["neighbors",r],["partial",e],["force_attn",o]]);return n.get(i)}static translate_compare({input:t,compare:e,neighbors:s=["decoder","encoder"]}){const r=w.ajax_request("../api/translate_compare"),n=new Map([["in",t],["compare",e],["neighbors",s]]);return r.get(n)}static closeWords({input:t,limit:e=50,loc:s="src"}){const r=w.ajax_request("../api/close_words"),n=new Map([["in",t],["loc",s],["limit",e]]);return r.get(n)}static trainDataIndices(t,e){const s=w.ajax_request("../api/train_data_for_index"),r=new Map([["indices",t.join(",")],["loc",e]]);return s.get(r)}}class f extends c{constructor(t,e,s={}){super(t,e),this.css_name="barlist",this.options={pos:{x:0,y:0},width:90,bar_height:20,css_class_main:"bar_list_vis",css_bar:"bar"},this._current={hidden:!1,xScale:r.k()},this.superInit(s,!1)}_init(){}_wrangle(t){const e=this._current,s=this.options,n=t.extent;e.xScale=r.k().domain(n).range([s.width,0]);const o=t.values;return this.parent.attrs({width:s.width,height:o.length*s.bar_height}),t}_render(t){const e=this.options,s=this._current,r=this.base.selectAll(`.${e.css_bar}`).data(t.values);r.exit().remove(),r.enter().append("rect").attr("class",e.css_bar).merge(r).attrs({x:t=>e.width-s.xScale(t),y:(t,s)=>s*e.bar_height,height:e.bar_height-2,width:t=>s.xScale(t)})}get xScale(){return this._current.xScale}}f.events={};class x extends c{constructor(t,e,s={}){super(t,e),this.css_name="statevis",this.options={pos:{x:0,y:0},cell_width:100,height:50,css_class_main:"state_vis",css_line:"state_line",x_offset:3,hidden:!0},this.superInit(s,!1)}_init(){this.options.hidden&&this.hideView(),this.layers.main=a.group(this.base,"main"),this.layers.axis=a.group(this.base,"axis")}_wrangle(t){const e=this.options,s=t.states,n=r.o(s),o=r.d(Object(u.flattenDeep)(n));return this.parent.attrs({width:s.length*e.cell_width+(e.x_offset+5+20),height:e.height}),{states:n,yDomain:o}}_render(t){const e=this.options,s=r.l().exponent(.5).domain(t.yDomain).range([e.height,0]),n=r.g().x((t,s)=>(t=>e.x_offset+Math.round((t+.5)*e.cell_width))(s)).y(t=>s(t)),o=this.layers.main.selectAll(`.${e.css_line}`).data(t.states);if(o.exit().remove(),o.enter().append("path").attr("class",e.css_line).merge(o).attrs({d:n}),t.states.length>0){const t=r.a(s).ticks(7);this.layers.axis.classed("axis state_axis",!0).call(t).selectAll("*"),this.layers.axis.attrs({transform:`translate(${e.x_offset+.5*e.cell_width-3},0)`})}else this.layers.axis.selectAll("*").remove()}}x.events={};class b extends c{constructor(t,e,s={}){super(t,e),this.css_name="closewordlist",this.options={pos:{x:0,y:0},height:400,width:1e3,lineSpacing:20,scoreWidth:100,css_class_main:"close_words",hidden:!1,data_access:{pos:t=>t.pos,scores:t=>t.score,words:t=>t.word,compare:t=>t.compare},text_measurer:null},this.superInit(s)}_init(){const t=this.options;this.options.text_measurer=this.options.text_measurer||new l(this.parent,"close_word_list"),this.parent.attrs({width:t.width,height:t.height}),this.options.hidden&&this.hideView()}_wrangle(t){console.log("wrnagle--- ");const e=this.options,s=e.data_access.words(t),r=s.map(t=>e.text_measurer.textLength(t)),n=e.data_access.scores(t),o=e.data_access.compare(t);return this._current.has_compare=null!==o,Object(u.sortBy)(Object(u.zipWith)(s,n,r,o,(t,e,s,r)=>({word:t,score:e,width:s,compare:r})),t=>-t.score)}_render(t){const e=this.options,s=t.length,n=e.lineSpacing,o=r.e(".2f");this.parent.attr("height",s*n);const i=this.layers.main.selectAll(".word").data(t);i.exit().remove();const a=i.enter().append("text").attr("class","word"),l=r.k().domain([0,s-1]).range([n/2,(s-.5)*n]);a.merge(i).attrs({x:()=>10,y:(t,e)=>l(e)}).text(t=>t.word);const c=Object(u.maxBy)(t,"width").width,d=Object(u.maxBy)(t,"score").score,h=r.k().domain([0,d]).range([0,e.scoreWidth]),p=this.layers.main.selectAll(".scoreBar").data(t);p.exit().remove();const m=p.enter().append("g").attr("class","scoreBar");m.append("rect"),m.append("text").attrs({x:2,y:n/2-2,class:"barText"});const g=m.merge(p).attrs({transform:(t,e)=>`translate(${c+10+10},${l(e)-n/2})`});if(g.select("rect").attrs({width:t=>h(t.score),height:n-4}),g.select("text").text(t=>o(t.score)),this._current.has_compare){const s=Object(u.max)(t.map(t=>t.compare.dist)),i=r.k().domain([0,s]).range([1,100]),a=this.layers.main.selectAll(".distBar").data(t);a.exit().remove();const d=a.enter().append("g").attr("class","distBar");d.append("rect"),d.append("text").attrs({x:2,y:n/2-2,class:"barText"});const h=d.merge(a).attrs({transform:(t,s)=>`translate(${c+10+10+e.scoreWidth+10},${l(s)-n/2})`});h.select("rect").attrs({width:t=>i(t.compare.dist),height:n-4}),h.select("text").text(t=>o(t.compare.dist));const p=this.layers.main.selectAll(".wordComp").data(t);p.exit().remove(),p.enter().append("text").attr("class","wordComp").merge(p).attrs({transform:(t,s)=>`translate(${c+10+10+e.scoreWidth+120},${l(s)})`}).text(t=>t.compare.sentence)}else this.layers.main.selectAll(".wordComp").remove()}}var y=s(24);class P extends c{constructor(t,e,s={}){super(t,e),this.css_name="stateprojector",this.options={pos:{x:0,y:0},css_class_main:"state_projector",keepAspectRatio:!1},this._current={hidden:!1,xScale:r.k(),yScale:r.k(),zoom:null,noOfLines:1,pivots:[[]],loc:"src",pivotNeighbors:{},project:{w:500,h:500},zoomTransform:r.r,hasLabels:!1,moreNeighbors:null,hideNN:!1},this.myNeighbors=((t,e)=>{const s=this._current.pivotNeighbors[t];return s&&s[e]||[]}),this.myNeighborIDs=((t,e)=>this.current.moreNeighbors?this.current.moreNeighbors[t][e]:this.myNeighbors(t,e).map(t=>t.id)),this.superInit(s,!0)}get current(){return this._current}get states(){return this.data.states}get loc(){return this.current.loc}get labels(){return this.data.labels}_init(){const t=r.q().scaleExtent([.5,4]).on("zoom",()=>this._zoomLayers(r.c.transform));this._current.zoom=t,this.layers.bg.append("rect").attr("id","zoomRect").attr("width",100).attr("height",100).style("fill","none").style("pointer-events","all").call(t).on("dblclick.zoom",()=>this.base.select("#zoomRect").transition().duration(200).call(t.transform,r.r))}_zoomLayers(t){this._current.zoomTransform=t,this.layers.fg.attr("transform",t.toString()),this.layers.main.attr("transform",t.toString());const e=1/Math.sqrt(t.k),s=5*e;this.layers.fg.selectAll(".plPoint").attr("r",s);const r=2*e;this.layers.fg.selectAll(".pl").style("stroke-width",r+"px")}static neighborDetails(t){return t.map(t=>{const[e,s,r,n]=t;return{indexID:e,distance:s,refTransID:r,refWordID:n}})}_wrangle(t){const e=this.options,s=this._current,n=P.neighborDetails;t.moreNeighbors&&(s.moreNeighbors=t.moreNeighbors);const o=t.states;let[i,a]=r.d(o.map(t=>t.pos[0])),[l,c]=r.d(o.map(t=>t.pos[1])),d=a-i,h=c-l;e.keepAspectRatio&&(d>h?h=d:d=h),s.xScale.domain([i,i+d]).range([10,s.project.w-10]),s.yScale.domain([l,l+h]).range([10,s.project.h-10]),s.loc=t.loc,s.pivotNeighbors={},o.filter(t=>!t.pivot).forEach(t=>n(t.occ).forEach(e=>{const r=s.pivotNeighbors[e.refTransID]||{},n=r[e.refWordID]||[];n.push(t),r[e.refWordID]=n,s.pivotNeighbors[e.refTransID]=r})),s.pivots=[],s.noOfLines=o.filter(t=>t.pivot&&0==t.pivot.word_ID).length;for(let t=0;t<s.noOfLines;t++)s.pivots.push(o.filter(e=>e.pivot&&e.pivot.trans_ID==t).sort((t,e)=>t.pivot.word_ID-e.pivot.word_ID));return s.hasLabels=null!=t.labels,this.parent.attrs({width:s.project.w,height:s.project.h}),this.layers.bg.select("#zoomRect").attrs({width:s.project.w,height:s.project.h}),t}_render(t){const e=t.states,s=this._current,r=s.xScale,n=s.yScale,o=P.neighborDetails;let i=this.layers.main.selectAll(".pp").data(e);i.exit().remove();let a=i.enter().append("g").attr("class","pp");a.append("circle"),(i=a.merge(i)).attr("transform",t=>`translate(${r(t.pos[0])},${n(t.pos[1])})`),i.select("circle").attr("r",t=>Math.sqrt(2*t.occ.length)),i.on("mouseenter",t=>{const e=this.layers.main.selectAll(".hoverLine").data(o(t.occ).map(t=>s.pivots[t.refTransID][t.refWordID]));e.exit().remove(),e.enter().append("line").attr("class","hoverLine").styles({fill:"none",stroke:"red","stroke-width":2/Math.sqrt(this._current.zoomTransform.k),"pointer-events":"none"}).merge(e).attrs({x1:r(t.pos[0]),y1:n(t.pos[1]),x2:t=>r(t.pos[0]),y2:t=>n(t.pos[1])})}),i.on("mouseleave",()=>{this.layers.main.selectAll(".hoverLine").remove()}),i.on("click",t=>{const e={loc:s.loc,pointIDs:[t.id],caller:this,neighborIDs:[t.id]};this.eventHandler.trigger(P.events.clicked,e)}),this.layers.fg.selectAll(".pl").remove(),this.layers.fg.selectAll(".plPoint").remove();for(let e=0;e<s.noOfLines;e++)this.lineDraw(s.pivots[e],"pl_"+e,s.hasLabels&&t.labels[e]||[])}lineDraw(t,e,s){const n=this._current;console.log(t,"--- onlyPivots",s);const o=r.g().x(t=>n.xScale(t.pos[0])).y(t=>n.yScale(t.pos[1]));let i=this.layers.fg.selectAll(".pl."+e).data([t]);(i=i.enter().append("path").attr("class","pl "+e).merge(i)).attr("d",o).style("stroke-width",2/Math.sqrt(n.zoomTransform.k)+"px");let a=this.layers.fg.selectAll(".plPoint."+e).data(t);a.exit().remove(),(a=a.enter().append("circle").attr("class","plPoint "+e).merge(a)).attrs({cx:t=>n.xScale(t.pos[0]),cy:t=>n.yScale(t.pos[1]),r:5/Math.sqrt(n.zoomTransform.k)}),a.classed("startPoint",t=>0===t.pivot.word_ID),a.classed("endPoint",e=>e.pivot.word_ID===t.length-1);const l=this.layers.fg.selectAll(".plLabel."+e).data(s);l.exit().remove(),l.enter().append("text").attr("class","plLabel "+e).merge(l).attrs({x:(e,s)=>n.xScale(t[s].pos[0]),y:(e,s)=>n.yScale(t[s].pos[1])}).text(t=>t),a.on("mouseenter",t=>{const e={hovered:!0,transID:t.pivot.trans_ID,wordID:t.pivot.word_ID,loc:n.loc,caller:this};this.eventHandler.trigger(P.events.hovered,e)}),a.on("mouseleave",t=>{const e={hovered:!1,transID:t.pivot.trans_ID,wordID:t.pivot.word_ID,loc:n.loc,caller:this};this.eventHandler.trigger(P.events.hovered,e)}),a.on("click",t=>{const e=this.myNeighborIDs(t.pivot.trans_ID,t.pivot.word_ID),s={loc:n.loc,pointIDs:[t.id],neighborIDs:e,caller:this};this.eventHandler.trigger(P.events.clicked,s)})}actionSelectPoints(t){this.layers.main.selectAll(".pp").classed("selected",e=>Object(u.includes)(t,e.id)),this.layers.fg.selectAll(".plPoint").classed("selected",e=>Object(u.includes)(t,e.id))}actionHoverPivot(t,e,s=!0){if(s){const s=this._current,n=(s.pivots[t][e],this.myNeighbors(t,e)),o=n.map(t=>[s.xScale(t.pos[0]),s.yScale(t.pos[1])]),i=y(o),a=r.g().curve(r.b),l=this.layers.main.selectAll(".hoverLine").data([i]);l.exit().remove(),l.enter().append("path").attr("class","hoverLine").merge(l).style("opacity",1/Math.sqrt(n.length)).attr("d",a)}else this.layers.main.selectAll(".hoverLine").remove()}actionHoverRegion(t,e,s=!0){let r=this.layers.fg.selectAll(".highlightRect").data(e?t:[]);r.exit().remove(),(r=r.enter().append("rect").attr("class","highlightRect").merge(r)).attrs({x:t=>t.x,y:t=>t.y,width:t=>t.w,height:t=>t.h})}}P.events={clicked:"state_projector_clicked",hovered:"state_projector_hovered"};class j extends c{constructor(t,e,s,r={}){super(t,s),this.projector=e,this.css_name="statepictograms",this.hiddenCanvas=null,this.options={pos:{x:0,y:0},gridElements:5},this.colors={bg:"#fffdfa",pp:{c:"black",a:.3},pl:{w:2,a:.3,c:["#4e9c57","#9c6d9b"]},select:{w:2,c:"#9c605f"}},this.superInit(r,!1,!0,!1)}_init(){const t=this.projector.current;this.hiddenCanvas=this.parent.append("canvas").attrs({width:t.project.w,height:t.project.h}).style("display","none")}_render(t){const e=this.projector.current,s=this.projector.states,r=this.colors,n=this.hiddenCanvas.node().getContext("2d");n.fillStyle=r.bg,n.fillRect(0,0,e.project.w,e.project.h),n.globalAlpha=r.pp.a,n.fillStyle=r.pp.c;for(const t of s)n.beginPath(),n.arc(e.xScale(t.pos[0]),e.yScale(t.pos[1]),Math.sqrt(t.occ.length),0,2*Math.PI),n.fill();const o=this.options.gridElements/e.project.w,i=e.project.w/this.options.gridElements,a=Math.ceil(i),l=[],c=e.pivots;for(const t of Object(u.range)(c.length)){const s=c[t],i=[];if(s.length>0){n.globalAlpha=r.pl.a,n.strokeStyle=r.pl.c[t],n.lineWidth=r.pl.w,n.beginPath();for(const t of Object(u.range)(s.length)){const r=s[t].pos;0==t?n.moveTo(e.xScale(r[0]),e.yScale(r[1])):n.lineTo(e.xScale(r[0]),e.yScale(r[1]))}n.stroke();const l=e.hasLabels&&this.projector.labels[t]||[];n.fillStyle=r.pl.c[t];let c=0;for(const r of s){const s=e.xScale(r.pos[0]),d=e.yScale(r.pos[1]),h=l[c]||""+c;i.push({ox:s,oy:d,x:Math.floor(s*o)/o,y:Math.floor(d*o)/o,id:r.id,loc:this.projector.loc,transID:t,wordID:c,ow:a,oh:a,word:h}),n.beginPath(),n.arc(s,d,5,0,2*Math.PI),n.fill(),c+=1}}l.push(i)}let d=this.parent.selectAll(".row").data(l);d.exit().remove();let h=(d=d.enter().append("div").attr("class","row").merge(d)).selectAll(".pCanvasFrame").data(t=>t);h.exit().remove();const p=h.enter().append("g").attr("class","pCanvasFrame");p.append("canvas").attrs({class:"pCanvas",width:a,height:a}),p.append("div");const m=this;(h=p.merge(h)).select(".pCanvas").each(function(t){const e=this.getContext("2d");e.fillStyle="black",e.drawImage(m.hiddenCanvas.node(),t.x,t.y,i,i,0,0,i,i),e.beginPath(),e.strokeStyle=r.select.c,e.lineWidth=r.select.w,e.arc(t.ox-t.x,t.oy-t.y,5,0,2*Math.PI),e.stroke()}),h.select("div").text(t=>t.word),h.on("mouseenter",t=>{const e={caller:this,segment:t,hovered:!0};this.eventHandler.trigger(j.events.segmentHovered,e)}),h.on("mouseleave",t=>{const e={caller:this,segment:t,hovered:!1};this.eventHandler.trigger(j.events.segmentHovered,e)}),h.on("click",t=>{const e=this.projector.myNeighbors(t.transID,t.wordID).map(t=>t.id),s={caller:this.projector,loc:this.projector.loc,pointIDs:[t.id],neighborIDs:e};this.eventHandler.trigger(P.events.clicked,s)})}actionHighlightSegment(t,e,s){s?this.parent.selectAll(".pCanvasFrame").classed("selected",s=>s.wordID===e&&s.transID===t):this.parent.selectAll(".pCanvasFrame").classed("selected",!1)}_wrangle(t){const e=this.projector.current;this.hiddenCanvas.attrs({width:e.project.w,height:e.project.h})}}j.events={segmentHovered:"state_picto_hovered"};class S extends c{constructor(t,e,s={}){super(t,e),this.css_name="beamtreevis",this.options={pos:{x:0,y:0},width:600,height:600},this.superInit(s,!0)}_init(){this.textMeasure=new l(this.base,"node")}_render(t){const e=this.options,s=r.f(t,t=>t.children);console.log(s,"--- root");const n=r.p().size([e.height-10,e.width-100]),o=n(s).descendants(),i=n(s).descendants().slice(1);console.log(o,"--- nodes");const a={};o.forEach(t=>{const e=t.data.name;a[e]=this.textMeasure.textLength(e)}),this.layers.main.selectAll("g.node").remove(),this.layers.bg.selectAll(".link").remove();let l=0,c=this.layers.main.selectAll("g.node").data(o,function(t){return t.id||(t.id=++l)});const d=c.enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+(t.y+5)+","+(t.x+5)+")"}).classed("topBeam",t=>t.data.topBeam);d.append("rect").style("fill","white"),d.append("text").attr("class","node_text").styles({"dominant-baseline":"middle"}),(c=d.merge(c)).select("rect").attrs({x:-2,width:t=>a[t.data.name]+4,height:6,y:-3}),c.select("text").text(t=>t.data.name);const h=r.h().x(t=>t.y+5).y(t=>t.x+5);let p=this.layers.bg.selectAll(".link").data(i,t=>t.id);p.enter().append("path").attr("class","link").merge(p).attr("d",t=>h({source:t,target:t.parent})).classed("topBeam",t=>t.data.topBeam)}_wrangle(t){if(t.maxDepth>0){this.parent.attr("width",70*t.maxDepth),this.options.width=70*t.maxDepth;const e=Math.max(150*Math.sqrt(t.maxDepth/10),150);this.parent.attr("height",e),this.options.height=e}return t.root}}class W{constructor(t){this.parent=t,this.current={highlightOffset:0,display:{tgt:!0,src:!0}},t.html('<div class="info_panel"><div class="menu"> show: <span class="show_src show_btn btn btn_left">src</span><span class="show_tgt show_btn btn btn_right">tgt</span> highlight: <span class="h_minus offset_btn btn btn_left">-1</span><span class="h_null offset_btn btn btn_center">0</span><span class="h_plus offset_btn btn btn_right">+1</span></div></div>'),this.infoPanel=t.select(".info_panel"),this.show_btns=t.selectAll(".show_btn"),this.offset_btns=t.selectAll(".offset_btn");const e=this;this.show_btns.on("click",function(){const t=r.m(this).text();e.current.display[t]=!e.current.display[t],e.updateMenu(),e.actionUpdateCurrent()}),this.offset_btns.on("click",function(){e.current.highlightOffset=+r.m(this).text(),e.updateMenu(),e.actionUpdateCurrent()}),this.updateMenu()}updateMenu(){const t=this;this.show_btns.classed("selected",function(){const e=r.m(this).text();return t.current.display[e]}),this.offset_btns.classed("selected",function(){const e=+r.m(this).text();return t.current.highlightOffset===e})}actionUpdateCurrent(){const t=this.current,e=this.data,s=this.infoPanel.selectAll(".translation");s.select(".src").html((s,r)=>this.renderHighlight(s.src,"src"===e.highlights.loc?e.highlights.indices[r]+t.highlightOffset:-1)).attr("hidden",!t.display.src||null),s.select(".tgt").html((s,r)=>this.renderHighlight(s.tgt,"tgt"===e.highlights.loc?e.highlights.indices[r]+t.highlightOffset:-1)).attr("hidden",!t.display.tgt||null)}cleanData(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}renderHighlight(t,e){return t.map((t,s)=>(t=this.cleanData(t),s===e?`<span class="highlight">${t}</span>`:t)).join(" ")}update(t){this.data=t;let e=this.infoPanel.selectAll(".translation").data(t.translations);e.exit().remove();const s=e.enter().append("div").attr("class","translation").style("display","table-row");s.html('<div style="display:table-cell;width: 30px; "></div><div style="display: table-cell;"><div class="src"></div><div class="tgt"></div><div style="padding-top: 10px;"></div></div>'),s.merge(e).order(),this.actionUpdateCurrent()}}function k(t){return{sideIndicator:null,selection:t,encoder_words:null,attention:null,decoder_words:null,beam:null}}class I{constructor(t){this.eventHandler=t,this._current={topN:0,hideStates:!1,box_width:40,wordProjector:null,closeWordsList:null,hasMediumPanel:!1,infoPanel:null},this.panels={projectorSelect:this._createProjectorOptions(),projectorPanel:r.m("#projectorPanel"),loadProjectButton:r.m("#loadProject"),loadProjectSpinner:r.m("#lPspinner"),enterComparison:{dialog:r.m("#comparisonDialog"),btn:r.m("#comparison_btn"),enc:r.m("#compare_enc"),encBtn:r.m("#cmp_translate"),dec:r.m("#compare_dec"),decBtn:r.m("#cmp_partial")},swapBtn:r.m("#make_pivot_btn"),wordMode:{wordBtn:r.m("#word_vector_fix_btn"),attnBtn:r.m("#attn_fix_btn"),attnApplyBtn:r.m("#apply_attn")},statePictoPanel:r.m("#statePictos")},this._vis={zero:k(r.m(".col0")),left:k(r.m(".col1")),middle:k(r.m(".col3")),right:k(r.m(".col5")),middle_extra:k(r.m(".col2")),right_extra:k(r.m(".col4")),projectors:this._createProjectorPanel(),statePicto:null,beamView:this._createBeamViewPanel()},this.init()}get vis(){return this._vis}init(){this.buildFullStack(this._vis.left),this._vis.statePicto=this._createStatePictoPanel(),this.buildDecorators(this._vis.zero)}_createStatePictoPanel(){return new j(r.m("#statePictos"),this._vis.projectors,this.eventHandler)}_createBeamViewPanel(){const t=r.m("#beam-view").append("svg").attrs({width:1e3,height:150});return new S(t,this.eventHandler,{width:1e3,height:150})}_createProjectorPanel(){const t=r.m("#projectorPanel").append("svg").attrs({width:500,height:30}),e=new P(t,this.eventHandler,{});return e.setHideElement(this.panels.projectorPanel),e}getMediumPanel(){return this._current.hasMediumPanel||(this.buildFullStack(this._vis.middle),this._current.hasMediumPanel=!0),{main:this._vis.middle,extra:this._vis.middle_extra}}removeMediumPanel(){this._current.hasMediumPanel&&(this._vis.middle_extra.selection.selectAll("*").remove(),this._vis.middle_extra=k(this._vis.middle_extra.selection),this._vis.middle.selection.selectAll("*").remove(),this._vis.middle=k(this._vis.middle.selection),this._current.hasMediumPanel=!1)}buildDecorators(t){t.encoder_words=I._setupPanel({col:t.selection,className:"encoder_words_setup",addSVG:!1,title:"Enc words: ",divStyles:{height:"21px",width:"100px","padding-top":"5px"}}),t.attention=I._setupPanel({col:t.selection,className:"attn_setup",addSVG:!1,title:"Attention: ",divStyles:{height:"50px",width:"100px"}}),t.decoder_words=this._createScoreVis({col:t.selection,className:"decoder_words_setup",divStyles:{height:"21px",width:"100px","padding-bottom":"5px"},options:{bar_height:20,data_access:t=>[t.scores[this._current.topN]],data_access_all:t=>t.scores}}),t.beam=I._setupPanel({col:t.selection,className:"beam_states_setup",addSVG:!1,title:"topK: ",divStyles:{height:"120px",width:"100px","padding-top":"0px"}})}buildFullStack(t){t.encoder_words=this._createWordLine({col:t.selection,className:"encoder_words",divStyles:{"padding-top":"5px"},options:{box_type:this._current.hideStates?h.BoxType.flow:h.BoxType.fixed,box_width:this._current.box_width}}),t.attention=this._createAttention({col:t.selection,className:"attn_vis",options:{}}),t.decoder_words=this._createWordLine({col:t.selection,className:"decoder_words",divStyles:{"padding-bottom":"5px"},options:{box_width:this._current.box_width,box_type:this._current.hideStates?h.BoxType.flow:h.BoxType.fixed,css_class_main:"outWord"}}),t.beam=this._createWordLine({col:t.selection,className:"beam_words",divStyles:{"padding-bottom":"5px"},options:{box_width:this._current.box_width,box_type:this._current.hideStates?h.BoxType.flow:h.BoxType.fixed,css_class_main:"topKWord"}}),t.sideIndicator=t.selection.append("div").classed("sideIndicator",!0).text("side")}static _setupPanel({col:t,className:e,divStyles:s,addSVG:r=!0,title:n=null}){const o=t.append("div").attr("class","setup "+e).styles(s);return n&&o.html(n),r?o.append("svg").attrs({width:100,height:30}).styles({display:"inline-block"}):o}_createScoreVis({col:t,className:e,options:s,divStyles:r}){const n=I._setupPanel({col:t,className:e,divStyles:r,addSVG:!0});return new f(n,this.eventHandler,s)}static _standardSVGPanel({col:t,className:e,divStyles:s}){return t.append("div").attr("class",e).styles(s).append("svg").attrs({width:500,height:30})}_createStatesVis({col:t,className:e,options:s,divStyles:r}){const n=I._standardSVGPanel({col:t,className:e,divStyles:r});return new x(n,this.eventHandler,s)}_createAttention({col:t,className:e,options:s,divStyles:r=null}){const n=I._standardSVGPanel({col:t,className:e,divStyles:r});return new m(n,this.eventHandler,s)}_createWordLine({col:t,className:e,options:s,divStyles:r}){const n=I._standardSVGPanel({col:t,className:e,divStyles:r});return new h(n,this.eventHandler,s)}_createWordProjector({col:t,className:e,options:s,divStyles:r}){const n=I._standardSVGPanel({col:t,className:e,divStyles:r});return new _(n,this.eventHandler,s)}_createCloseWordList({col:t,className:e,options:s,divStyles:r}){const n=I._standardSVGPanel({col:t,className:e,divStyles:r});return new b(n,this.eventHandler,s)}getWordProjector(){return null===this._current.wordProjector&&(this.closeAllRight(),this._current.wordProjector=this._createWordProjector({col:this._vis.right.selection,className:"word_projector",divStyles:{},options:{}})),this._current.wordProjector}getInfoPanel(){return null===this._current.infoPanel&&(this.closeAllRight(),this._current.infoPanel=new W(this._vis.right.selection)),this._current.infoPanel}closeAllRight(){this._vis.right.selection.selectAll("*").remove(),this._vis.right=k(this._vis.right.selection),this._current.wordProjector=null,this._current.infoPanel=null}getWordList(){return null===this._current.closeWordsList&&(this._current.closeWordsList=this._createCloseWordList({col:this._vis.right.selection,className:"close_word_list",divStyles:{"padding-top":"10px"},options:{}})),this._current.closeWordsList}_createProjectorOptions(){return r.m("#projectorSelect")}updateProjectionSelectField(t,e=null){const s=this.panels.projectorSelect.selectAll("option").data(t);s.exit().remove(),s.enter().append("option").merge(s).attr("value",t=>t).text(t=>t),e&&this.panels.projectorSelect.property("value",e)}setVisibilityNeighborPanels(t){this.panels.projectorPanel.style("display",t?null:"none"),this.panels.statePictoPanel.style("display",t?null:"none")}}var E,D;s(61);class A{static get events(){return{modalDialogCanceled:"modalDialogCanceled",modalDialogSubmitted:"modalDialogSubmitted"}}static open(t,e,s=300){t.selectAll(".uiCancel").on("click",()=>{A.close(t),e.trigger(A.events.modalDialogCanceled,t)}),t.selectAll(".uiSubmit").on("click",()=>{e.trigger(A.events.modalDialogSubmitted,t)}),r.m("body").append("div").attr("class","inactivator").styles({opacity:0}).transition().style("opacity",.5),t.attr("hidden",null);const n=t.node().clientHeight;t.raise().style("width",`${s}px`).style("opacity",1).style("top",`${-n}px`).style("left",`${(window.innerWidth-s)/2}px`),t.transition().style("top","5px")}static close(t){r.n(".inactivator").remove();const e=t.node().clientHeight;t.transition().style("top",`${-e}px`).style("opacity",0).on("end",function(){r.m(this).attr("hidden",!0)})}}class N{constructor(t){this._result=null,this.attention_save=null,this._result=t,this.attention_save=Object(u.cloneDeep)(this.attn)}increaseAttn(t,e,s=0,r=.1){const n=this._result.attn[s][t],o=n.length,i=Object(u.sum)(n)-n[e];for(const t in Object(u.range)(o))t==e?n[t]+=r:(n[t]-=n[t]*r/i,n[t]=Math.max(n[t],0));return this.filterAttention(),n}setAttn(t,e,s=0){const r=this._result.attn[s][t],n=r.length;for(const t in Object(u.range)(n))t==e?(console.log("-hen-- encPOS "),r[t]=1):r[t]=0;return this.filterAttention(),r}resetAttn(t,e=0){this._result.attn[e][t]=this.attention_save[e][t]}filterAttention(t=.75){if(this._result.attn.length>0){const e=[];for(const s of this._result.attn){const r=[];for(const e of s){const s=e.map((t,e)=>[t,e]).sort((t,e)=>e[0]-t[0]),n=new Array(e.length).fill(0);let o=0,i=0;for(;o<t&&i<e.length;){const t=s[i][0];n[s[i][1]]=t,o+=t,i++}r.push(n)}e.push(r)}return this._result.attnFiltered=e,!0}return!1}get encoderWords(){return this._result.encoder.map(t=>t.token)}get inputSentence(){return this.encoderWords.join(" ")}get decoderWords(){return this._result.decoder.map(t=>t.map(t=>t.token))}get allNeighbors(){return this._result.allNeighbors}get beam_trace_words(){return this._result.beam_trace_words}get beam(){return this._result.beam}get result(){return this._result}get attn(){return this._result.attn}get attnFiltered(){return this._result.attnFiltered}get encoder(){return this._result.encoder}get encoderNeighbors(){return this._result.encoder.map(t=>t.neighbors)}get decoder(){return this._result.decoder}get decoderNeighbors(){return this._result.decoder.map(t=>t.map(t=>t.neighbors))}get contextNeighbors(){return this._result.decoder.map(t=>t.map(t=>t.neighbor_context))}get scores(){return this._result.scores}}!function(t){t[t.none=0]="none",t[t.enc_diff=1]="enc_diff",t[t.dec_dff=2]="dec_dff"}(E||(E={})),function(t){t[t.word=0]="word",t[t.attn=1]="attn"}(D||(D={}));s(56);class O{static basicURL(){const t=window.location.pathname.split("/").slice(0,-2).join("/");return window.location.origin+(t.length?t:"")}static get parameters(){const t=window.location.search.substring(1).split("&");console.log(t,"--- vars");const e={},s=t=>(t=>/^[0-9]+$/.test(t))(t)?Number.parseInt(t,10):(t=>/^[0-9]+\.[0-9]*$/.test(t))(t)?Number.parseFloat(t):t;return t.forEach(t=>{if(t.length>0){const r=t.split("="),n=decodeURIComponent(r[0]);let o=decodeURIComponent(r[1]);const i=o.startsWith("..");i&&(o=o.slice(2)),o.length<1?e[n]=i?[]:"":e[n]=i?o.split(",").map(t=>s(t)):s(o)}}),e}static enrichParameters(t){const e=O.parameters;return Object.keys(t).forEach(s=>e[s]=t[s]),e}static urlString(t){const e=[];Object.keys(t).forEach(s=>{const r=t[s];if(void 0!==r){let t=r;Array.isArray(r)&&(t=".."+r.join(",")),e.push(encodeURI(s+"="+t))}});const s=window.location.pathname;let r=s.substring(s.lastIndexOf("/")+1);return e.length>0&&(r+="?"+e.join("&")),r}static setURLParam(t,e,s=!0){const r=O.parameters;r[t]=e,O.updateUrl(r,s)}static updateUrl(t,e=!0){e?window.history.pushState(t,"",O.urlString(t)):window.history.replaceState(t,"",O.urlString(t))}}s(28),s(27);window.onload=(()=>{const t=new class{constructor(){this._current={beamIndex:0,inWordPos:[],outWordPos:[],inWords:[],outWords:[],allNeighbors:{},projectedNeighbor:null,sentence:null,translations:[null,null],comparison:E.none,wordClickMode:D.word,attnChange:{selected:-1,changes:{}}},this.eventHandler=new n(r.m("body").node()),this.pm=new I(this.eventHandler),this._init(),this._bindEvents()}_init(){}selectProjection(t){this.pm.setVisibilityNeighborPanels(!0),this._current.projectedNeighbor=t;let e=this._current.translations.map(e=>null==e?[]:t.startsWith("enc")?e.encoderWords:e.decoderWords[0]);const s={encoder:t=>t.encoder.map(t=>t.neighbors.map(t=>t[0])),decoder:t=>t.decoder[0].map(t=>t.neighbors.map(t=>t[0])),context:t=>t.decoder[0].map(t=>t.neighbor_context.map(t=>t[0]))};let r=null;if(t in s){const e=s[t];r=this._current.translations.map(t=>null==t?[]:e(t))}this.pm.vis.projectors.update({states:this._current.allNeighbors[t],loc:t.startsWith("enc")?"src":"tgt",labels:e,moreNeighbors:r}),this.pm.vis.statePicto.update(null)}updateProjectorData(t){const e=this._current;if(e.allNeighbors=t,t){const s=Object.keys(t);e.projectedNeighbor||(e.projectedNeighbor=s.indexOf("decoder")>-1?"decoder":s[0]),this.pm.panels.projectorSelect.style("display",null),this.pm.panels.loadProjectButton.style("display","none"),this.pm.vis.statePicto.unhideView(),this.pm.vis.projectors.unhideView(),this.pm.updateProjectionSelectField(s,e.projectedNeighbor),this.selectProjection(e.projectedNeighbor)}else this.pm.panels.projectorSelect.style("display","none"),this.pm.panels.loadProjectButton.style("display",null),this.pm.vis.statePicto.hideView(),this.pm.vis.projectors.hideView()}clearCompare(){this._current.translations[1]=null,this._current.comparison=E.none}update(t,e=this.pm.vis.left,s=this.pm.vis.zero,n=!1){const o=this._current;t.filterAttention(.75);const i=e.encoder_words,a=e.decoder_words;i.update({wordRows:[t.encoderWords]}),a.update({wordRows:[t.decoderWords[o.beamIndex]]});const l={inWidths:i.rows[0].map(t=>t.width),outWidths:a.rows[o.beamIndex].map(t=>t.width),inPos:i.positions[0],outPos:a.positions[o.beamIndex],edgeWeights:t.attnFiltered[o.beamIndex]};if(e.attention.update(l),n)o.translations[1]=t,e.sideIndicator.classed("side_compare",!0).text("compare");else{o.translations[0]=t,e.sideIndicator.classed("side_pivot",!0).text("pivot"),this._current.sentence=t.inputSentence,this.updateProjectorData(t.allNeighbors);const s=t.decoderWords[o.beamIndex],r=t.beam_trace_words,n={},i="<s>"===r[0][0][0],a={name:r[0][0][0],children:[]};n[r[0][0][0]]=a;for(const t of r.slice(i?1:0))for(const e of t){const[t]=e.slice(-1),r=e.slice(0,-1).join("||"),o=e.join("||");let a=null;const l={name:t,children:[],topBeam:a=i?Object(u.isEqual)(e.slice(1),s.slice(0,e.length-1)):Object(u.isEqual)(e.slice(0),s.slice(0,e.length))};o in n||(n[r].children.push(l),n[o]=l)}this.pm.vis.beamView.update({root:a,maxDepth:r.length})}if("beam"in e){let s=[],n=[],o=[];const i=t.decoderWords[0];for(const e in Object(u.range)(t.beam[0].length)){const r=[],a=[],l=[];for(const s in t.beam){const n=t.beam[s][e].word;r.push(n),n===i[s]?a.push("#ccc2a3"):a.push(null),l.push(t.beam[s][e].score)}s.push(r),n.push(a),o.push(l)}const a=r.d(Object(u.flatten)(o)),l=r.k().domain(a).range(["#fff","#999"]),c=(o.map(t=>t.map(t=>l(t))),r.k().domain(a).range([1,e.beam.options.box_width-10])),d=o.map(t=>t.map(t=>c(t)));e.beam.update({wordRows:s,boxWidth:d,wordFill:n})}if(s){const e=t=>{const e=r.d(t);return e[0]*e[1]>0&&(e[0]>0&&(e[0]=e[1]),e[1]=0),e};s.decoder_words.update({extent:e(t.scores),values:[t.scores[o.beamIndex]]})}}cleanPanels(){this.pm.closeAllRight(),this.pm.removeMediumPanel()}updateAndShowWordProjector(t,e){this.pm.setVisibilityNeighborPanels(!1);const s=this.pm.getWordProjector();console.log(t,"--- WP_data"),s.options.loc=e,s.update(t)}updateAndShowWordList(t){this.pm.getWordList().update(t)}updateProjectInfo(t){if(t.has_neighbors||this.pm.panels.loadProjectButton.style("display","none"),t.pre_cached&&t.pre_cached.length>0){this.pm.panels.loadProjectButton.remove(),this.pm.panels.loadProjectButton=r.m("#alternativeProjectText"),this.pm.panels.loadProjectButton.style("display","block");const e=t.pre_cached.map(t=>`<div style="padding-top: 3pt;"><a href='index.html?in=${t.in}' style="font-weight: bold;">${t.in}</a></div>`).join("\n");this.pm.panels.loadProjectButton.html("<hr> Enjoy playing with the Translation View above. For the demo, we only support Neighbor View for the following examples:<br>"+e+"<hr>")}}_bindEvents(){const t=this.pm.vis,e=t=>{const{main:e,extra:s}=this.pm.getMediumPanel();this.update(new N(t.compare),e,null,!0),this.updateProjectorData(t.neighbors)},s=e=>{if(this._current.wordClickMode===D.attn&&this._current.attnChange.selected>-1)return;e.caller.actionHighlightWord(e.row,e.col,e.hovered);const{vType:s,col:r}=(e=>e===t.left.encoder_words?{vType:m.VERTEX_TYPE.src,col:t.left}:e===t.middle.encoder_words?{vType:m.VERTEX_TYPE.src,col:t.middle}:e===t.middle.decoder_words?{vType:m.VERTEX_TYPE.tgt,col:t.middle}:{vType:m.VERTEX_TYPE.tgt,col:t.left})(e.caller);let n=0;r!=this.pm.vis.left&&(r.attention.actionHighlightEdges(e.col,s,e.hovered),n=1),this.pm.vis.left.attention.actionHighlightEdges(e.col,s,e.hovered);const o=this.pm.vis.projectors,i=this.pm.vis.statePicto;!1===o.current.hidden&&(s===m.VERTEX_TYPE.src&&"src"===o.loc?(o.actionHoverPivot(n,e.col,e.hovered),i.actionHighlightSegment(n,e.col,e.hovered)):s===m.VERTEX_TYPE.tgt&&"tgt"===o.loc&&(o.actionHoverPivot(n,e.col,e.hovered),i.actionHighlightSegment(n,e.col,e.hovered)))};this.eventHandler.bind(h.events.wordHovered,s);const r=({input:t,loc:e,limit:s,allWords:r,replaceIndex:n})=>{this.cleanPanels(),v.closeWords({input:t,loc:e,limit:s}).then(t=>{const s=JSON.parse(t);s.compare="src"===e?s.word.map(t=>({orig:r.map((e,s)=>s===n?t:e).join(" ")})):s.word.map(t=>({orig:r.map((e,s)=>s===n?t:s<n?e:"").join(" ").trim()})),this.updateAndShowWordProjector(s,e)}).catch(t=>console.log(t,"--- error"))};this.eventHandler.bind(h.events.wordSelected,(e,n)=>{if(e.caller===t.left.encoder_words||e.caller===t.left.decoder_words){let s="src",n=m.VERTEX_TYPE.src;if(e.caller===t.left.decoder_words&&(s="tgt",n=m.VERTEX_TYPE.tgt),this._current.wordClickMode===D.word)e.caller.actionHighlightWord(e.row,e.col,e.hovered,!0,"selected"),r({input:e.word.word.text,loc:s,limit:20,allWords:e.caller.firstRowPlainWords,replaceIndex:e.col});else if(this._current.wordClickMode===D.attn){const t=this._current.attnChange;if("tgt"===s&&(t.selected!=e.col?(t.selected=e.col,e.caller.actionHighlightWord(e.row,e.col,!0,!0,"selected"),this.pm.vis.left.attention.actionHighlightEdges(e.col,n,!0,"highlight")):(t.selected=-1,e.caller.actionHighlightWord(e.row,e.col,!1,!0,"selected"),this.pm.vis.left.attention.actionHighlightEdges(e.col,n,!1,"highlight"))),"src"===s)if(t.selected>-1){const s=this._current.translations[0].setAttn(t.selected,e.col);t.changes[t.selected]=Object(u.indexOf)(s,Object(u.max)(s)),this.pm.panels.wordMode.attnApplyBtn.style("display",null),console.log(s,t.selected,e.col,"--- a, aChg.selected, d.col"),this.update(this._current.translations[0]),this.pm.vis.left.decoder_words.actionHighlightWord(0,t.selected,!0,!0,"selected"),this.pm.vis.left.attention.actionHighlightEdges(t.selected,m.VERTEX_TYPE.tgt,!0,"highlight")}else alert("Please select a decoder word first. Then you can increase respective weights by clicking on encoder")}}else if(e.caller===t.left.beam){const t=this._current.translations[0].decoderWords[0].slice(0,e.col).join(" ")+" "+e.word.word.text;this.pm.closeAllRight(),v.translate({input:this._current.translations[0].inputSentence,partial:[t],neighbors:[]}).then(t=>{t=JSON.parse(t),console.log(t,"--- data"),this.update(new N(t)),s(e)})}}),this.pm.panels.wordMode.attnApplyBtn.on("click",()=>{this.pm.panels.wordMode.attnApplyBtn.style("display","none");const t=Object(u.min)(Object.keys(this._current.attnChange.changes).map(t=>+t)),e=this._current.translations[0].decoderWords[0].slice(0,t).join(" ");v.translate({input:this._current.translations[0].inputSentence,partial:[e],neighbors:[],force_attn:this._current.attnChange.changes}).then(t=>{t=JSON.parse(t),console.log(t,"--- data"),this.update(new N(t))})}),this.eventHandler.bind(_.events.wordClicked,t=>{t.caller.highlightWord(t.word,!0,!0,"selected"),"src"===t.caller.options.loc?v.translate_compare({input:this._current.sentence,compare:t.sentence,neighbors:[]}).then(t=>{this._current.comparison=E.enc_diff,t=JSON.parse(t),e(t)}):v.translate({input:this._current.sentence,partial:[t.sentence],neighbors:[]}).then(t=>{this._current.comparison=E.none,t=new N(JSON.parse(t)),this.update(t)})}),this.eventHandler.bind(P.events.clicked,t=>{t.caller.actionSelectPoints(t.pointIDs),v.trainDataIndices(t.neighborIDs,t.loc).then(t=>{const e=JSON.parse(t);this.pm.getInfoPanel().update({translations:e.res.map(t=>({src:t.src_words,tgt:t.tgt_words})),highlights:{loc:e.loc,indices:e.res.map(t=>t.tokenId)}})})});const n=(t,e,s,r)=>{const n=[this.pm.vis.left,this.pm.vis.middle];let o=m.VERTEX_TYPE.src;const i=n[e];"src"===t?i.encoder_words.actionHighlightWord(0,s,r):(o=m.VERTEX_TYPE.tgt,i.decoder_words.actionHighlightWord(0,s,r));for(const t in Object(u.range)(e+1))n[t].attention.actionHighlightEdges(s,o,r);this.pm.vis.projectors.actionHoverPivot(e,s,r),this.pm.vis.statePicto.actionHighlightSegment(e,s,r)};this.eventHandler.bind(P.events.hovered,t=>{n(t.loc,t.transID,t.wordID,t.hovered)}),this.eventHandler.bind(j.events.segmentHovered,t=>{const e=t.segment;n(e.loc,e.transID,e.wordID,t.hovered),this.pm.vis.projectors.actionHoverRegion([{x:e.x,y:e.y,h:e.oh,w:e.ow}],t.hovered)}),this.pm.panels.loadProjectButton.on("click",()=>{this.pm.panels.loadProjectSpinner.style("display","inline"),this._current.comparison===E.enc_diff?v.translate_compare({input:this._current.translations[0].inputSentence,compare:this._current.translations[1].inputSentence}).then(t=>{this.cleanPanels(),this._current.comparison=E.enc_diff,t=JSON.parse(t),this.pm.panels.loadProjectSpinner.style("display","none"),this.update(new N(t.in)),e(t)}):this._current.comparison===E.none&&v.translate({input:this._current.sentence}).then(t=>{this.cleanPanels();const e=JSON.parse(t);console.log(e,"--- raw_data"),this.pm.panels.loadProjectSpinner.style("display","none"),this.update(new N(e))})}),this.pm.panels.projectorSelect.on("change",()=>{const t=this.pm.panels.projectorSelect.property("value");this.selectProjection(t)});const o=this.pm.panels.enterComparison;o.btn.on("click",()=>{const t=this._current.translations[0];A.open(o.dialog,this.eventHandler,400),o.enc.property("value",t.inputSentence),o.dec.property("value",t.decoderWords[0].join(" "))}),o.encBtn.on("click",()=>{const t=o.enc.property("value").trim();v.translate_compare({input:this._current.sentence,compare:t,neighbors:[]}).then(t=>{this._current.comparison=E.enc_diff,t=JSON.parse(t),e(t)}),A.close(o.dialog)}),o.decBtn.on("click",()=>{const t=o.dec.property("value").trim();v.translate({input:this._current.translations[0].inputSentence,partial:[t],neighbors:[]}).then(t=>{this._current.comparison=E.enc_diff,t=JSON.parse(t);const{main:e,extra:s}=this.pm.getMediumPanel();this.update(new N(t),e,null,!0)}),A.close(o.dialog)}),this.pm.panels.swapBtn.on("click",()=>{if(!this._current.translations[1])return;const t=this._current.translations[1],e=this._current.translations[0];this.update(t);const{main:s,extra:r}=this.pm.getMediumPanel();this.update(e,s,null,!0)}),this.pm.panels.wordMode.attnBtn.on("click",()=>{this.pm.panels.wordMode.attnBtn.classed("selected",!0),this.pm.panels.wordMode.wordBtn.classed("selected",!1),this._current.wordClickMode=D.attn}),this.pm.panels.wordMode.wordBtn.on("click",()=>{this.pm.panels.wordMode.attnBtn.classed("selected",!1),this.pm.panels.wordMode.wordBtn.classed("selected",!0),this._current.wordClickMode=D.word})}},e=e=>{v.translate({input:e,neighbors:[]}).then(e=>{const s=JSON.parse(e);t.clearCompare(),t.update(new N(s)),t.cleanPanels(),document.querySelector("#spinner").style.display="none"}).catch(t=>console.log(t,"--- error"))};r.m("#query_input").on("keypress",()=>{const t=r.c.keyCode;r.c instanceof KeyboardEvent&&13===t&&(()=>{document.querySelector("#spinner").style.display=null;const t=r.m("#query_input").node().value.trim();O.setURLParam("in",t,!1),e(t)})()}),v.project_info(null).then(s=>{s=JSON.parse(s),t.updateProjectInfo(s);const n=O.parameters.in;n&&(r.m("#query_input").node().value=n,e(n))})})},27:function(t,e,s){t.exports=s.p+"s2s_logo.png"},28:function(t,e,s){t.exports=s.p+"index.html"},56:function(t,e){},61:function(t,e){}});